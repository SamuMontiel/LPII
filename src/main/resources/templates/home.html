<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VirtualHub - Tienda</title>
    <link rel="stylesheet" th:href="@{/css/home.css}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />
</head>
<body class="home-page">


    <header class="steam-navbar">
        <div class="navbar-container">
            <div class="navbar-left">
                <a th:href="@{/home}" class="navbar-logo">üéÆ <span>VIRTUALHUB</span></a>
                <nav class="navbar-tabs">
                    <a th:href="@{/home}" th:classappend="${activePage == 'home'} ? 'active' : ''" class="tab-item active">TIENDA</a>
                    <a th:href="@{/biblioteca}" th:classappend="${activePage == 'biblioteca'} ? 'active' : ''" class="tab-item">BIBLIOTECA</a>
                    <a th:href="@{/comunidad}" th:classappend="${activePage == 'comunidad'} ? 'active' : ''" class="tab-item">COMUNIDAD</a>
                    <a th:href="@{/perfil}" th:classappend="${activePage == 'perfil'} ? 'active' : ''" class="tab-item">PERFIL</a>
                </nav>
            </div>
            <div class="navbar-right">
   
                <div class="notifications-dropdown">
                    <button class="btn-notifications" onclick="toggleNotifications()">
                        <i class="fas fa-bell"></i>
                        <span class="notification-badge" th:if="${notificacionesNoLeidas > 0}" 
                              th:text="${notificacionesNoLeidas}"></span>
                    </button>
                    <div class="notifications-panel" id="notificationsPanel">
                        <div class="notifications-header">
                            <h4>Notificaciones</h4>
                            <button onclick="marcarTodasLeidas()" class="btn-mark-read">
                                <i class="fas fa-check-double"></i>
                            </button>
                        </div>
                        <div class="notifications-list" id="notificationsList">
                            <div class="no-notifications">
                                <i class="fas fa-bell-slash"></i>
                                <p>No tienes notificaciones</p>
                            </div>
                        </div>
                        <div class="notifications-footer">
                            <a href="#" onclick="verTodasNotificaciones(event)">Ver todas</a>
                        </div>
                    </div>
                </div>


                <a th:href="@{/carrito}" class="cart-btn">
                    <i class="fas fa-shopping-cart"></i>
                    <span class="cart-count" th:if="${cantidadCarrito != null and cantidadCarrito > 0}"
                          th:text="${cantidadCarrito}">0</span>
                </a>

                <div class="saldo-pill">
                    <i class="fas fa-wallet"></i> S/ <span th:text="${#numbers.formatDecimal(usuario.saldo, 1, 2)}"></span>
                </div>

                <a th:href="@{/perfil}" class="username-link" th:text="${#strings.toUpperCase(usuario.nombre)}"></a>

                <form th:action="@{/logout}" method="post" class="logout-form">
                    <button type="submit" class="logout-btn">Cerrar sesi√≥n</button>
                </form>
            </div>
        </div>
    </header>

    <section class="hero-slider" th:if="${juegos != null and !juegos.isEmpty()}">
        <div class="hero-slide"
             th:each="juego,iter : ${juegos}"
             th:classappend="${iter.index == 0} ? ' active' : ''"
             th:if="${juego.bannerUrl != null}"
             th:style="'background-image:url(' + ${juego.bannerUrl} + ')'">

            <div class="hero-overlay"></div>

            <div class="hero-content">
                <h1 th:text="${juego.titulo}"></h1>
                <p th:text="${juego.descripcion}"></p>

                <div class="hero-price">
                    S/ <span th:text="${juego.precio}"></span>
                </div>

                <div th:if="${juegosComprados.contains(juego.id)}">
                    <button class="btn-disabled" disabled>
                        <i class="fas fa-check"></i> En tu biblioteca
                    </button>
                </div>

                <div th:unless="${juegosComprados.contains(juego.id)}">
                    <button class="hero-btn"
                            type="button"
                            th:attr="data-id=${juego.id}"
                            onclick="irATienda(this)">
                        <i class="fas fa-shopping-bag"></i> Comprar ahora
                    </button>
                </div>
            </div>
        </div>

        <div class="hero-indicators">
            <span th:each="juego,iter : ${juegos}"
                  th:classappend="${iter.index == 0} ? ' active' : ''"></span>
        </div>
    </section>

    <section class="recommended" th:if="${juegos != null and juegos.size() > 4}">
        <h2 class="section-title">
            <i class="fas fa-star"></i> Recomendado para ti
        </h2>

        <div class="recommended-row">
            <div class="recommended-card"
                 th:each="juego,iter : ${juegos}"
                 th:if="${iter.index > 0 and iter.index < 5}"
                 th:onclick="'window.location.href=\'#tienda\';'">

                <img th:src="@{${juego.coverUrl}}" th:alt="${juego.titulo}">

                <div class="recommended-info">
                    <h3 th:text="${juego.titulo}"></h3>
                    <span>S/ <span th:text="${juego.precio}"></span></span>
                </div>
            </div>
        </div>
    </section>


    <main class="store-container" id="tienda">
        <h2 class="section-title">
            <i class="fas fa-store"></i> Tienda
        </h2>

        <div class="games-grid">
            <div class="game-card" th:each="juego : ${juegos}" th:data-id="${juego.id}">
                <img th:src="@{${juego.coverUrl}}" class="game-image" th:alt="${juego.titulo}">

                <div class="game-info">
                    <h3 th:text="${juego.titulo}"></h3>
                    <p th:text="${juego.descripcion}"></p>

                    <div class="price">
                        <span class="currency">S/</span> <span th:text="${juego.precio}"></span>
                    </div>

                    <div th:if="${juegosComprados.contains(juego.id)}">
                        <button class="btn-disabled" disabled>
                            <i class="fas fa-check-circle"></i> En biblioteca
                        </button>
                    </div>

                    <div th:unless="${juegosComprados.contains(juego.id)}">
                        <form th:action="@{/carrito/agregar/{id}(id=${juego.id})}" method="post">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                            <button class="btn-comprar" type="submit" onclick="animarAlCarrito(event, this)">
                                <i class="fas fa-cart-plus"></i> Agregar al carrito
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div class="toast-notification" id="toast">
        <i class="fas fa-check-circle"></i> Juego agregado al carrito
    </div>


    <audio id="addSound" src="https://assets.mixkit.co/sfx/preview/mixkit-game-click-1114.mp3" preload="auto"></audio>

    <script>
    
        let notificacionesInterval = null;

        document.addEventListener("DOMContentLoaded", function() {
            const slides = document.querySelectorAll(".hero-slide");
            const indicators = document.querySelectorAll(".hero-indicators span");

            if (slides.length > 0) {
                let current = 0;

                function showSlide(index) {
                    slides.forEach(s => s.classList.remove("active"));
                    indicators.forEach(i => i.classList.remove("active"));
                    slides[index].classList.add("active");
                    indicators[index].classList.add("active");
                    current = index;
                }

                function nextSlide() {
                    let next = current + 1;
                    if (next >= slides.length) next = 0;
                    showSlide(next);
                }

                setInterval(nextSlide, 5000);

                indicators.forEach((indicator, index) => {
                    indicator.addEventListener("click", () => showSlide(index));
                });
            }

            actualizarContadorNotificaciones();
            notificacionesInterval = setInterval(actualizarContadorNotificaciones, 30000);
        });

        function toggleNotifications() {
            const panel = document.getElementById('notificationsPanel');
            panel.classList.toggle('show');
            if (panel.classList.contains('show')) {
                cargarNotificaciones();
            }
        }

        function cargarNotificaciones() {
            fetch('/notificaciones/recientes')
                .then(response => response.json())
                .then(data => {
                    const lista = document.getElementById('notificationsList');
                    if (data.length === 0) {
                        lista.innerHTML = `
                            <div class="no-notifications">
                                <i class="fas fa-bell-slash"></i>
                                <p>No tienes notificaciones</p>
                            </div>
                        `;
                        return;
                    }
                    
                    let html = '';
                    data.forEach(notif => {
                        const icono = notif.tipo === 'LOGRO' ? 'üèÜ' : 
                                     notif.tipo === 'AMIGO' ? 'üë•' : 'üîî';
                        
                        html += `
                            <div class="notification-item ${notif.leida ? '' : 'unread'}" 
                                 onclick="marcarLeida(${notif.id})">
                                <div class="notification-icon ${notif.tipo.toLowerCase()}">
                                    ${icono}
                                </div>
                                <div class="notification-content">
                                    <div class="notification-message">${notif.mensaje}</div>
                                    <div class="notification-time">${notif.fecha}</div>
                                </div>
                            </div>
                        `;
                    });
                    lista.innerHTML = html;
                });
        }

        function marcarLeida(id) {
            const token = document.querySelector('meta[name="_csrf"]').getAttribute('content');
            const header = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
            const headers = {};
            headers[header] = token;
            
            fetch('/notificaciones/marcar/' + id, { method: 'POST', headers: headers })
                .then(() => {
                    cargarNotificaciones();
                    actualizarContadorNotificaciones();
                });
        }

        function marcarTodasLeidas() {
            const token = document.querySelector('meta[name="_csrf"]').getAttribute('content');
            const header = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
            const headers = {};
            headers[header] = token;
            
            fetch('/notificaciones/marcar-todas', { method: 'POST', headers: headers })
                .then(() => {
                    cargarNotificaciones();
                    actualizarContadorNotificaciones();
                });
        }

        function actualizarContadorNotificaciones() {
            fetch('/notificaciones/no-leidas')
                .then(response => response.json())
                .then(data => {
                    const badge = document.querySelector('.notification-badge');
                    if (data.cantidad > 0) {
                        if (!badge) {
                            const btn = document.querySelector('.btn-notifications');
                            const newBadge = document.createElement('span');
                            newBadge.className = 'notification-badge';
                            newBadge.textContent = data.cantidad;
                            btn.appendChild(newBadge);
                        } else {
                            badge.textContent = data.cantidad;
                        }
                    } else if (badge) {
                        badge.remove();
                    }
                });
        }

        function verTodasNotificaciones(event) {
            event.preventDefault();
            showNotification('Funcionalidad en desarrollo', 'info');
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = 'notification ' + type;
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
                <span>${message}</span>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 100);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        function animarAlCarrito(event, button) {

            
            const toast = document.getElementById("toast");
            toast.classList.add("show");

            document.getElementById("addSound").play();

            const countSpan = document.querySelector(".cart-count");
            if (countSpan) {
                let value = parseInt(countSpan.innerText || "0");
                countSpan.innerText = value + 1;
            }

            const card = button.closest(".game-card");
            const img = card.querySelector("img");
            const carrito = document.querySelector(".cart-btn");

            if (img && carrito) {
                const imgRect = img.getBoundingClientRect();
                const carritoRect = carrito.getBoundingClientRect();

                const clon = img.cloneNode(true);
                clon.style.position = "fixed";
                clon.style.left = imgRect.left + "px";
                clon.style.top = imgRect.top + "px";
                clon.style.width = imgRect.width + "px";
                clon.style.height = imgRect.height + "px";
                clon.style.transition = "all 0.7s ease-in-out";
                clon.style.zIndex = "9999";
                clon.style.borderRadius = "12px";
                clon.style.boxShadow = "0 0 20px #66fcf1";

                document.body.appendChild(clon);

                setTimeout(() => {
                    clon.style.left = carritoRect.left + "px";
                    clon.style.top = carritoRect.top + "px";
                    clon.style.width = "30px";
                    clon.style.height = "30px";
                    clon.style.opacity = "0.5";
                }, 10);

                setTimeout(() => clon.remove(), 700);
            }

            setTimeout(() => {
                toast.classList.remove("show");
            }, 2000);
        }

        function irATienda(button) {
            const tienda = document.getElementById("tienda");
            const juegoId = button.getAttribute("data-id");

            if (!tienda) return;

            tienda.scrollIntoView({ behavior: "smooth", block: "start" });

            setTimeout(() => {
                const cards = document.querySelectorAll(".game-card");
                cards.forEach(card => {
                    if (card.dataset.id === juegoId) {
                        card.classList.add("highlight");
                        setTimeout(() => card.classList.remove("highlight"), 2000);
                    }
                });
            }, 500);
        }


        document.querySelectorAll(".game-card").forEach(card => {
            card.addEventListener("mousemove", e => {
                const rect = card.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;

                const centerX = rect.width / 2;
                const centerY = rect.height / 2;

                const rotateX = (y - centerY) / 15;
                const rotateY = (centerX - x) / 15;

                card.style.transform = `rotateX(${rotateX}deg) rotateY(${rotateY}deg) scale(1.03)`;
            });

            card.addEventListener("mouseleave", () => {
                card.style.transform = "rotateX(0) rotateY(0) scale(1)";
            });
        });

     
        window.addEventListener("scroll", () => {
            const hero = document.querySelector(".hero-slide.active");
            if (!hero) return;
            const offset = window.scrollY * 0.4;
            hero.style.backgroundPosition = `center ${offset}px`;
        });

        document.addEventListener('click', function(event) {
            const panel = document.getElementById('notificationsPanel');
            const btn = document.querySelector('.btn-notifications');
            
            if (btn && panel && !btn.contains(event.target) && !panel.contains(event.target)) {
                panel.classList.remove('show');
            }
        });
    </script>

</body>
</html>
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Comunidad - VirtualHub</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" th:href="@{/css/comunidad.css}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
</head>
<body class="community-page">
    <div id="particles-js"></div>

    <!-- NAVBAR UNIFICADO (IGUAL QUE EN PERFIL) -->
    <header class="steam-navbar">
        <div class="navbar-container">
            <div class="navbar-left">
                <a th:href="@{/home}" class="navbar-logo">üéÆ <span>VIRTUALHUB</span></a>
                <nav class="navbar-tabs">
                    <a th:href="@{/home}" th:classappend="${activePage == 'home'} ? 'active' : ''" class="tab-item">TIENDA</a>
                    <a th:href="@{/biblioteca}" th:classappend="${activePage == 'biblioteca'} ? 'active' : ''" class="tab-item">BIBLIOTECA</a>
                    <a th:href="@{/comunidad}" th:classappend="${activePage == 'comunidad'} ? 'active' : ''" class="tab-item active">COMUNIDAD</a>
                    <a th:href="@{/perfil}" th:classappend="${activePage == 'perfil'} ? 'active' : ''" class="tab-item">PERFIL</a>
                </nav>
            </div>
            <div class="navbar-right">
                <!-- NOTIFICACIONES (IGUAL QUE EN PERFIL) -->
                <div class="notifications-dropdown">
                    <button class="btn-notifications" onclick="toggleNotifications()">
                        <i class="fas fa-bell"></i>
                        <span class="notification-badge" th:if="${notificacionesNoLeidas > 0}" 
                              th:text="${notificacionesNoLeidas}"></span>
                    </button>
                    <div class="notifications-panel" id="notificationsPanel">
                        <div class="notifications-header">
                            <h4>Notificaciones</h4>
                            <button onclick="marcarTodasLeidas()" class="btn-mark-read">
                                <i class="fas fa-check-double"></i>
                            </button>
                        </div>
                        <div class="notifications-list" id="notificationsList">
                            <div class="no-notifications">
                                <i class="fas fa-bell-slash"></i>
                                <p>No tienes notificaciones</p>
                            </div>
                        </div>
                        <div class="notifications-footer">
                            <a href="#" onclick="verTodasNotificaciones(event)">Ver todas</a>
                        </div>
                    </div>
                </div>
                
                <!-- SALDO Y LOGOUT (IGUAL QUE EN PERFIL) -->
                <div class="saldo-pill">
                    <i class="fas fa-wallet"></i> S/ <span th:text="${usuarioLogueado != null ? #numbers.formatDecimal(usuarioLogueado.saldo,1,2) : '0.00'}"></span>
                </div>
                <form th:action="@{/logout}" method="post" class="logout-form">
                    <button type="submit" class="logout-btn">Cerrar sesi√≥n</button>
                </form>
            </div>
        </div>
    </header>

    <div class="profile-wrapper">
        <div class="profile-left">
            <h3 class="section-title">Comunidad de Juegos</h3>

            <div th:each="juego : ${juegos}" class="activity-card-modern">
                <img th:src="${juego.coverUrl}" class="activity-cover" 
                     onerror="this.src='https://images.unsplash.com/photo-1550745165-9bc0b252726f?w=140&h=80&fit=crop'">

                <div class="activity-info">
                    <h4 th:text="${juego.titulo}"></h4>
                    <p th:text="${juego.descripcion}"></p>

                    <!-- Lista de comentarios -->
                    <div class="comments-section">
                        <h5>Comentarios <span class="comment-count" th:text="'(' + ${juego.comentarios.size()} + ')'"></span></h5>

                        <!-- Si hay comentarios -->
                        <div th:if="${!#lists.isEmpty(juego.comentarios)}">
                            <div th:each="comentario : ${juego.comentarios}" class="comment-card">
                                <div class="comment-header">
                                    <img th:src="${comentario.usuario.avatarUrl != null ? comentario.usuario.avatarUrl : 'https://i.pravatar.cc/30?u=' + comentario.usuario.id}" 
                                         class="comment-avatar">
                                    <strong class="comment-author" th:text="${comentario.usuario.nombre}"></strong>
                                    <span class="comment-date" th:text="${#temporals.format(comentario.fecha,'dd MMM yyyy HH:mm')}"></span>
                                </div>
                                <p class="comment-content" th:text="${comentario.contenido}"></p>

                                <!-- Acciones del comentario (solo autor) -->
                                <div class="comment-actions" th:if="${comentario.usuario.email == usuario.email}">
                                    <button class="btn-edit-comment" th:onclick="'editarComentario(' + ${comentario.id} + ')'">
                                        <i class="fas fa-edit"></i> Editar
                                    </button>
                                    <form th:action="@{/comunidad/borrar}" method="post" class="delete-form" 
                                          onsubmit="return confirm('¬øEliminar comentario?')">
                                        <input type="hidden" name="comentarioId" th:value="${comentario.id}">
                                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                        <button type="submit" class="btn-delete">
                                            <i class="fas fa-trash"></i> Borrar
                                        </button>
                                    </form>
                                </div>

                                <!-- Formulario para responder -->
                                <form th:action="@{/comunidad/responder}" method="post" class="reply-form">
                                    <input type="hidden" name="comentarioId" th:value="${comentario.id}">
                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                    <div class="reply-input-group">
                                        <textarea name="contenido" placeholder="Responder..." required></textarea>
                                        <button type="submit">
                                            <i class="fas fa-reply"></i> Responder
                                        </button>
                                    </div>
                                </form>

                                <!-- Lista de respuestas -->
                                <div class="replies-section" th:if="${!#lists.isEmpty(comentario.respuestas)}">
                                    <div th:each="respuesta : ${comentario.respuestas}" class="reply-card">
                                        <div class="reply-header">
                                            <img th:src="${respuesta.usuario.avatarUrl != null ? respuesta.usuario.avatarUrl : 'https://i.pravatar.cc/20?u=' + respuesta.usuario.id}" 
                                                 class="reply-avatar">
                                            <strong class="reply-author" th:text="${respuesta.usuario.nombre}"></strong>
                                            <span class="reply-date" th:text="${#temporals.format(respuesta.fecha,'dd MMM HH:mm')}"></span>
                                        </div>
                                        <p class="reply-content" th:text="${respuesta.contenido}"></p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Si NO hay comentarios -->
                        <div th:if="${#lists.isEmpty(juego.comentarios)}" class="no-comments">
                            <i class="fas fa-comment-slash"></i>
                            <p>Todav√≠a no hay comentarios para este juego. ¬°S√© el primero en comentar!</p>
                        </div>
                    </div>

                    <!-- Formulario para comentar -->
                    <form th:action="@{/comunidad/comentar}" method="post" class="comment-form">
                        <input type="hidden" name="juegoId" th:value="${juego.id}">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                        <textarea name="contenido" placeholder="Escribe tu comentario..." required></textarea>
                        <button type="submit" class="btn-comment">
                            <i class="fas fa-paper-plane"></i> Comentar
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <div class="profile-right">
            <!-- USUARIOS ACTIVOS -->
            <div class="sidebar-card">
                <h5><i class="fas fa-users"></i> Usuarios Activos</h5>
                <div class="active-users-list">
                    <div th:each="usuario : ${usuarios}" class="active-user-item">
                        <img th:src="${usuario.avatarUrl != null ? usuario.avatarUrl : 'https://i.pravatar.cc/30?u=' + usuario.id}" 
                             class="user-avatar-small">
                        <span class="user-name" th:text="${usuario.nombre}"></span>
                        <span class="user-status online"></span>
                    </div>
                </div>
            </div>
            
            <!-- JUEGOS POPULARES -->
            <div class="sidebar-card">
                <h5><i class="fas fa-fire"></i> Juegos Populares</h5>
                <div th:each="juego : ${juegosPopular}" class="popular-game-item">
                    <img th:src="${juego.coverUrl}" class="game-icon-small">
                    <span class="game-name" th:text="${juego.titulo}"></span>
                    <span class="game-comments" th:text="${juego.comentarios.size()} + ' comentarios'"></span>
                </div>
            </div>
            
            <!-- ESTAD√çSTICAS -->
            <div class="sidebar-card stats-mini">
                <h5><i class="fas fa-chart-bar"></i> Estad√≠sticas</h5>
                <div class="stat-mini-item">
                    <span>Miembros:</span>
                    <strong th:text="${totalUsuarios}"></strong>
                </div>
                <div class="stat-mini-item">
                    <span>Comentarios:</span>
                    <strong th:text="${totalComentarios}"></strong>
                </div>
                <div class="stat-mini-item">
                    <span>Juegos:</span>
                    <strong th:text="${juegos.size()}"></strong>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
        <p>VirtualHub ¬© 2026 ‚Ä¢ Comunidad Gamer</p>
        <div class="footer-links">
            <a href="#">Acerca de</a>
            <a href="#">T√©rminos</a>
            <a href="#">Privacidad</a>
            <a href="#">Contacto</a>
        </div>
    </footer>

    <script>
        // Variables globales
        let notificacionesInterval = null;
        
        // FUNCIONES PARA NOTIFICACIONES (IGUAL QUE EN PERFIL)
        function toggleNotifications() {
            const panel = document.getElementById('notificationsPanel');
            panel.classList.toggle('show');
            if (panel.classList.contains('show')) {
                cargarNotificaciones();
            }
        }

        function cargarNotificaciones() {
            fetch('/notificaciones/recientes')
                .then(response => response.json())
                .then(data => {
                    const lista = document.getElementById('notificationsList');
                    if (data.length === 0) {
                        lista.innerHTML = `
                            <div class="no-notifications">
                                <i class="fas fa-bell-slash"></i>
                                <p>No tienes notificaciones</p>
                            </div>
                        `;
                        return;
                    }
                    
                    let html = '';
                    data.forEach(notif => {
                        const icono = notif.tipo === 'LOGRO' ? 'üèÜ' : 
                                     notif.tipo === 'AMIGO' ? 'üë•' : 'üîî';
                        
                        html += `
                            <div class="notification-item ${notif.leida ? '' : 'unread'}" 
                                 onclick="marcarLeida(${notif.id})">
                                <div class="notification-icon ${notif.tipo.toLowerCase()}">
                                    ${icono}
                                </div>
                                <div class="notification-content">
                                    <div class="notification-message">${notif.mensaje}</div>
                                    <div class="notification-time">${notif.fecha}</div>
                                </div>
                            </div>
                        `;
                    });
                    lista.innerHTML = html;
                });
        }

        function marcarLeida(id) {
            const token = document.querySelector('meta[name="_csrf"]').getAttribute('content');
            const header = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
            const headers = {};
            headers[header] = token;
            
            fetch('/notificaciones/marcar/' + id, { method: 'POST', headers: headers })
                .then(() => {
                    cargarNotificaciones();
                    actualizarContadorNotificaciones();
                });
        }

        function marcarTodasLeidas() {
            const token = document.querySelector('meta[name="_csrf"]').getAttribute('content');
            const header = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
            const headers = {};
            headers[header] = token;
            
            fetch('/notificaciones/marcar-todas', { method: 'POST', headers: headers })
                .then(() => {
                    cargarNotificaciones();
                    actualizarContadorNotificaciones();
                });
        }

        function actualizarContadorNotificaciones() {
            fetch('/notificaciones/no-leidas')
                .then(response => response.json())
                .then(data => {
                    const badge = document.querySelector('.notification-badge');
                    if (data.cantidad > 0) {
                        if (!badge) {
                            const btn = document.querySelector('.btn-notifications');
                            const newBadge = document.createElement('span');
                            newBadge.className = 'notification-badge';
                            newBadge.textContent = data.cantidad;
                            btn.appendChild(newBadge);
                        } else {
                            badge.textContent = data.cantidad;
                        }
                    } else if (badge) {
                        badge.remove();
                    }
                });
        }

        function verTodasNotificaciones(event) {
            event.preventDefault();
            alert('Funcionalidad en desarrollo');
        }

        function showNotification(message, type = 'success') {
            alert(message); // Simple por ahora
        }

        function editarComentario(id) {
            alert('Editar comentario ' + id + ' - Funcionalidad en desarrollo');
        }

        // Cerrar panel al hacer clic fuera
        document.addEventListener('click', function(event) {
            const panel = document.getElementById('notificationsPanel');
            const btn = document.querySelector('.btn-notifications');
            
            if (btn && panel && !btn.contains(event.target) && !panel.contains(event.target)) {
                panel.classList.remove('show');
            }
        });

        // Iniciar actualizaci√≥n de notificaciones
        document.addEventListener('DOMContentLoaded', function() {
            actualizarContadorNotificaciones();
            notificacionesInterval = setInterval(actualizarContadorNotificaciones, 30000);
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
    <script>
        particlesJS("particles-js", {
            "particles": {
                "number": { "value": 80, "density": { "enable": true, "value_area": 800 } },
                "color": { "value": "#66c0f4" },
                "shape": { "type": "circle" },
                "opacity": { "value": 0.5, "random": false },
                "size": { "value": 3, "random": true },
                "line_linked": {
                    "enable": true,
                    "distance": 150,
                    "color": "#66c0f4",
                    "opacity": 0.4,
                    "width": 1
                },
                "move": {
                    "enable": true,
                    "speed": 2,
                    "direction": "none",
                    "random": false,
                    "straight": false,
                    "out_mode": "out"
                }
            },
            "interactivity": {
                "detect_on": "canvas",
                "events": {
                    "onhover": { "enable": true, "mode": "grab" },
                    "onclick": { "enable": true, "mode": "push" }
                },
                "modes": {
                    "grab": { "distance": 140, "line_linked": { "opacity": 1 } },
                    "push": { "particles_nb": 4 }
                }
            },
            "retina_detect": true
        });
    </script>
</body>
</html>
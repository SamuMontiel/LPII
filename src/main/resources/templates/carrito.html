<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VirtualHub - Carrito</title>
    <link rel="stylesheet" th:href="@{/css/carrito.css}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />
</head>
<body>

<header class="steam-navbar">
    <div class="navbar-container">
        <div class="navbar-left">
            <a th:href="@{/home}" class="navbar-logo">üéÆ <span>VIRTUALHUB</span></a>
            <nav class="navbar-tabs">
                <a th:href="@{/home}" class="tab-item">TIENDA</a>
                <a th:href="@{/biblioteca}" class="tab-item">BIBLIOTECA</a>
                <a th:href="@{/comunidad}" class="tab-item">COMUNIDAD</a>
                <a th:href="@{/perfil}" class="tab-item">PERFIL</a>
            </nav>
        </div>
        <div class="navbar-right">
            <div class="notifications-dropdown">
                <button class="btn-notifications" onclick="toggleNotifications()">
                    <i class="fas fa-bell"></i>
                    <span class="notification-badge" th:if="${notificacionesNoLeidas > 0}" 
                          th:text="${notificacionesNoLeidas}"></span>
                </button>
                <div class="notifications-panel" id="notificationsPanel">
                    <div class="notifications-header">
                        <h4>Notificaciones</h4>
                        <button onclick="marcarTodasLeidas()" class="btn-mark-read">
                            <i class="fas fa-check-double"></i>
                        </button>
                    </div>
                    <div class="notifications-list" id="notificationsList">
                        <div class="no-notifications">
                            <i class="fas fa-bell-slash"></i>
                            <p>No tienes notificaciones</p>
                        </div>
                    </div>
                    <div class="notifications-footer">
                        <a href="#" onclick="verTodasNotificaciones(event)">Ver todas</a>
                    </div>
                </div>
            </div>

            <div class="saldo-pill">
                <i class="fas fa-wallet"></i> S/ <span th:text="${#numbers.formatDecimal(usuario.saldo, 1, 2)}"></span>
            </div>

            <a th:href="@{/perfil}" class="username-link" th:text="${#strings.toUpperCase(usuario.nombre)}"></a>

            <form th:action="@{/logout}" method="post" class="logout-form">
                <button type="submit" class="logout-btn">Cerrar sesi√≥n</button>
            </form>
        </div>
    </div>
</header>

<canvas id="particles"></canvas>

<main class="carrito-container">

    <h2><i class="fas fa-shopping-cart"></i> Mi Carrito</h2>

    <div th:if="${items.isEmpty()}" class="carrito-vacio">
        <i class="fas fa-shopping-cart fa-4x"></i>
        <p>Tu carrito est√° vac√≠o</p>
        <a th:href="@{/home}" class="btn-ir-tienda">Ir a la tienda</a>
    </div>

    <div th:unless="${items.isEmpty()}">
        <table class="tabla-carrito">
            <thead>
                <tr>
                    <th>Juego</th>
                    <th>Nombre</th>
                    <th>Precio</th>
                    <th>Acci√≥n</th>
                </tr>
            </thead>
            <tbody>
                <tr th:each="item : ${items}">
                    <td>
                        <img th:src="@{${item.juego.coverUrl}}"
                             class="carrito-img"
                             alt="cover">
                    </td>
                    <td th:text="${item.juego.titulo}"></td>
                    <td>S/ <span th:text="${#numbers.formatDecimal(item.juego.precio,1,2)}"></span></td>
                    <td>
                        <form th:action="@{'/carrito/eliminar/' + ${item.id}}" method="post">
                            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                            <button type="submit" class="btn-eliminar">
                                <i class="fas fa-trash"></i> Eliminar
                            </button>
                        </form>
                    </td>
                </tr>
            </tbody>
        </table>

        <div class="confirmar-box">
            <form th:action="@{/carrito/confirmar}" method="post" id="formConfirmar">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                <div class="resumen-compra">
                    <div class="total-line">
                        <span>Total:</span>
                        <span class="total-valor">S/ <span id="totalCompra" th:text="${#numbers.formatDecimal(total,1,2)}"></span></span>
                    </div>
                    <div id="mensajeSaldo" class="saldo-error"></div>
                </div>
                <button type="submit" class="btn-confirmar" id="btnConfirmar">
                    <i class="fas fa-check-circle"></i> Confirmar compra
                </button>
            </form>
        </div>
    </div>

</main>

<script>
    let notificacionesInterval = null;

    function toggleNotifications() {
        const panel = document.getElementById('notificationsPanel');
        panel.classList.toggle('show');
        if (panel.classList.contains('show')) {
            cargarNotificaciones();
        }
    }

    function cargarNotificaciones() {
        fetch('/notificaciones/recientes')
            .then(response => response.json())
            .then(data => {
                const lista = document.getElementById('notificationsList');
                if (data.length === 0) {
                    lista.innerHTML = `
                        <div class="no-notifications">
                            <i class="fas fa-bell-slash"></i>
                            <p>No tienes notificaciones</p>
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                data.forEach(notif => {
                    const icono = notif.tipo === 'LOGRO' ? 'üèÜ' : 
                                 notif.tipo === 'AMIGO' ? 'üë•' : 'üîî';
                    
                    html += `
                        <div class="notification-item ${notif.leida ? '' : 'unread'}" 
                             onclick="marcarLeida(${notif.id})">
                            <div class="notification-icon ${notif.tipo.toLowerCase()}">
                                ${icono}
                            </div>
                            <div class="notification-content">
                                <div class="notification-message">${notif.mensaje}</div>
                                <div class="notification-time">${notif.fecha}</div>
                            </div>
                        </div>
                    `;
                });
                lista.innerHTML = html;
            });
    }

    function marcarLeida(id) {
        const token = document.querySelector('meta[name="_csrf"]').getAttribute('content');
        const header = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
        const headers = {};
        headers[header] = token;
        
        fetch('/notificaciones/marcar/' + id, { method: 'POST', headers: headers })
            .then(() => {
                cargarNotificaciones();
                actualizarContadorNotificaciones();
            });
    }

    function marcarTodasLeidas() {
        const token = document.querySelector('meta[name="_csrf"]').getAttribute('content');
        const header = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
        const headers = {};
        headers[header] = token;
        
        fetch('/notificaciones/marcar-todas', { method: 'POST', headers: headers })
            .then(() => {
                cargarNotificaciones();
                actualizarContadorNotificaciones();
            });
    }

    function actualizarContadorNotificaciones() {
        fetch('/notificaciones/no-leidas')
            .then(response => response.json())
            .then(data => {
                const badge = document.querySelector('.notification-badge');
                if (data.cantidad > 0) {
                    if (!badge) {
                        const btn = document.querySelector('.btn-notifications');
                        const newBadge = document.createElement('span');
                        newBadge.className = 'notification-badge';
                        newBadge.textContent = data.cantidad;
                        btn.appendChild(newBadge);
                    } else {
                        badge.textContent = data.cantidad;
                    }
                } else if (badge) {
                    badge.remove();
                }
            });
    }

    function verTodasNotificaciones(event) {
        event.preventDefault();
        mostrarNotificacion('Funcionalidad en desarrollo', 'info');
    }

    function mostrarNotificacion(mensaje, tipo = 'success') {
        const notificacion = document.createElement('div');
        notificacion.className = 'notificacion ' + tipo;
        notificacion.innerHTML = `
            <i class="fas fa-${tipo === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
            <span>${mensaje}</span>
        `;
        document.body.appendChild(notificacion);
        
        setTimeout(() => notificacion.classList.add('show'), 100);
        setTimeout(() => {
            notificacion.classList.remove('show');
            setTimeout(() => notificacion.remove(), 300);
        }, 3000);
    }

    document.addEventListener('click', function(event) {
        const panel = document.getElementById('notificationsPanel');
        const btn = document.querySelector('.btn-notifications');
        
        if (btn && panel && !btn.contains(event.target) && !panel.contains(event.target)) {
            panel.classList.remove('show');
        }
    });

    document.addEventListener("DOMContentLoaded", function() {
        actualizarContadorNotificaciones();
        notificacionesInterval = setInterval(actualizarContadorNotificaciones, 30000);

        const saldo = parseFloat(document.querySelector(".saldo-pill span").innerText);
        const total = parseFloat(document.getElementById("totalCompra").innerText);
        const btnConfirmar = document.getElementById("btnConfirmar");
        const mensaje = document.getElementById("mensajeSaldo");

        if (total > saldo) {
            btnConfirmar.disabled = true;
            mensaje.innerText = "‚ùå Saldo insuficiente";
        }

        btnConfirmar.addEventListener("click", function(e) {
            if (btnConfirmar.disabled) return;
            e.preventDefault();

            const overlay = document.createElement("div");
            overlay.className = "compra-exitosa";

            overlay.innerHTML = `
                <div class="compra-box">
                    <i class="fas fa-check-circle fa-4x" style="color: #4caf50;"></i>
                    <h2>¬°Compra realizada!</h2>
                    <p>Gracias por tu compra en VirtualHub</p>
                    <div class="compra-botones">
                        <button id="btnBiblioteca" class="btn-accion">
                            <i class="fas fa-book"></i> Ir a Biblioteca
                        </button>
                    </div>
                </div>
            `;

            document.body.appendChild(overlay);

            document.getElementById("btnBiblioteca").addEventListener("click", function() {
                window.location.href = "/biblioteca";
            });

            setTimeout(() => {
                document.getElementById("formConfirmar").submit();
            }, 2000);
        });
    });

    const canvas = document.getElementById("particles");
    const ctx = canvas.getContext("2d");

    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    let particlesArray = [];

    class Particle {
        constructor(){
            this.x = Math.random() * canvas.width;
            this.y = Math.random() * canvas.height;
            this.size = Math.random() * 2;
            this.speedX = (Math.random() - 0.5) * 0.5;
            this.speedY = (Math.random() - 0.5) * 0.5;
        }
        update(){
            this.x += this.speedX;
            this.y += this.speedY;

            if(this.x > canvas.width) this.x = 0;
            if(this.x < 0) this.x = canvas.width;
            if(this.y > canvas.height) this.y = 0;
            if(this.y < 0) this.y = canvas.height;
        }
        draw(){
            ctx.fillStyle = "#66fcf1";
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
            ctx.fill();
        }
    }

    function init(){
        particlesArray = [];
        for(let i = 0; i < 100; i++){
            particlesArray.push(new Particle());
        }
    }

    function animate(){
        ctx.clearRect(0,0,canvas.width,canvas.height);
        particlesArray.forEach(p => {
            p.update();
            p.draw();
        });
        requestAnimationFrame(animate);
    }

    init();
    animate();

    window.addEventListener("resize", function(){
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        init();
    });
</script>

</body>
</html>
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Biblioteca - VirtualHub</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>

<div class="library-container">

    <div class="library-sidebar">
        <h2>Biblioteca</h2>

        <div th:each="uj : ${biblioteca}"
             class="library-item"
             onclick="mostrarJuego(this)"
             th:data-id="${uj.juego.id}"
             th:data-titulo="${uj.juego.titulo}"
             th:data-descripcion="${uj.juego.descripcion}"
             th:data-imagen="${uj.juego.imagenUrl}"
             th:data-horas="${uj.horasJugadas}"
             th:data-sesion="${uj.ultimaSesion}">

            <span th:text="${uj.juego.titulo}"></span>
        </div>
    </div>

    <div class="library-detail">
        <div id="detalleContenido">
            <h1>Selecciona un juego</h1>
            <p>Haz click en un juego de tu biblioteca</p>
        </div>
    </div>

</div>
<div id="launchModal" class="launch-modal">
    <div class="launch-box">
        <h2>Juego ejecut√°ndose...</h2>
        <p>Tiempo en sesi√≥n...</p>
        <button class="btn-jugar" onclick="cerrarJuego()">Cerrar juego</button>
    </div>
</div>

<script>

let startTime;
let juegoActualId;

function mostrarJuego(elemento) {

    document.querySelectorAll(".library-item")
        .forEach(item => item.classList.remove("activo"));

    elemento.classList.add("activo");

    const id = elemento.dataset.id;
    const titulo = elemento.dataset.titulo;
    const descripcion = elemento.dataset.descripcion;
    const imagen = elemento.dataset.imagen;
    const horas = elemento.dataset.horas;
    const sesion = elemento.dataset.sesion;

    document.querySelector(".library-detail").style.background =
        `linear-gradient(rgba(15,20,27,0.9), rgba(15,20,27,0.95)), 
         url('${imagen}') center/cover no-repeat`;

    document.getElementById("detalleContenido").innerHTML = `
        <div class="detalle-header">
            <img src="${imagen}" class="library-img">

            <div class="detalle-info">
                <h1>${titulo}</h1>
                <p class="detalle-descripcion">${descripcion}</p>

                <div class="stats">
                    <p>‚è≥ Horas jugadas: ${parseFloat(horas).toFixed(2)}</p>
                    <p>üïí √öltima sesi√≥n: ${sesion ? sesion : "Nunca"}</p>
                </div>

                <button class="btn-jugar"
                        onclick="launchGame(${id})">
                    JUGAR
                </button>
            </div>
        </div>
    `;
}

function launchGame(id){

    juegoActualId = id;
    startTime = new Date();

    const modal = document.getElementById("launchModal");
    modal.style.display = "flex";
}

function cerrarJuego(){

    const endTime = new Date();
    const minutos = (endTime - startTime) / 60000;

    fetch(`/cerrar-juego/${juegoActualId}`, {
        method: "POST",
        headers: {
            "Content-Type": "application/x-www-form-urlencoded"
        },
        body: `minutos=${minutos}`
    }).then(() => {
        location.reload();
    });
}

</script>

</body>
</html>
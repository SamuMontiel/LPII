<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Perfil - VirtualHub</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" th:href="@{/css/perfil.css}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
</head>
<body class="profile-page">

	<!-- NAVBAR - con notificaciones -->
	<header class="steam-navbar">
	    <div class="navbar-container">
	        <div class="navbar-left">
	            <a th:href="@{/home}" class="navbar-logo">üéÆ <span>VIRTUALHUB</span></a>
	            <nav class="navbar-tabs">
	                <a th:href="@{/home}" th:classappend="${activePage == 'home'} ? 'active' : ''" class="tab-item">TIENDA</a>
	                <a th:href="@{/biblioteca}" th:classappend="${activePage == 'biblioteca'} ? 'active' : ''" class="tab-item">BIBLIOTECA</a>
	                <a th:href="@{/comunidad}" th:classappend="${activePage == 'comunidad'} ? 'active' : ''" class="tab-item">COMUNIDAD</a>
	                <a th:href="@{/perfil}" th:classappend="${activePage == 'perfil'} ? 'active' : ''" class="tab-item">PERFIL</a>
	            </nav>
	        </div>
	        <div class="navbar-right">
	            <!-- ‚úÖ NUEVO: Sistema de notificaciones -->
	            <div class="notifications-dropdown">
	                <button class="btn-notifications" onclick="toggleNotifications()">
	                    <i class="fas fa-bell"></i>
	                    <span class="notification-badge" th:if="${notificacionesNoLeidas > 0}" 
	                          th:text="${notificacionesNoLeidas}"></span>
	                </button>
	                <div class="notifications-panel" id="notificationsPanel">
	                    <div class="notifications-header">
	                        <h4>Notificaciones</h4>
	                        <button onclick="marcarTodasLeidas()" class="btn-mark-read">
	                            <i class="fas fa-check-double"></i>
	                        </button>
	                    </div>
	                    <div class="notifications-list" id="notificationsList">
	                        <!-- Las notificaciones se cargar√°n aqu√≠ -->
	                    </div>
	                    <div class="notifications-footer">
	                        <a href="#" onclick="verTodasNotificaciones(event)">Ver todas</a>
	                    </div>
	                </div>
	            </div>
	            
	            <div class="saldo-pill">
	                <i class="fas fa-wallet"></i> S/ <span th:text="${#numbers.formatDecimal(usuario.saldo,1,2)}"></span>
	            </div>
	            <form th:action="@{/logout}" method="post" class="logout-form">
	                <button type="submit" class="logout-btn">Cerrar sesi√≥n</button>
	            </form>
	        </div>
	    </div>
	</header>

    <!-- HERO BANNER -->
    <div class="steam-profile-hero" 
         th:style="'background-image: url(' + (${juegoMasJugado != null ? juegoMasJugado.juego.bannerUrl : 'https://images.unsplash.com/photo-1542751371-adc38448a05e?w=1400&h=440&fit=crop'}) + ')'">

        <!-- AVATAR -->
        <div class="avatar-container">
            <div class="avatar-frame">
                <img th:src="${usuario.avatarUrl != null ? usuario.avatarUrl : 'https://i.pravatar.cc/150?u=' + usuario.id}" alt="Avatar">
            </div>
        </div>

        <div class="hero-content">
            <h1 class="hero-name" th:text="${#strings.toUpperCase(usuario.nombre)}"></h1>
            <p class="real-name" th:text="${usuario.nombre}"></p>
            
            <!-- BIOGRAF√çA -->
            <div class="user-bio" th:if="${usuario.bio != null and !usuario.bio.isEmpty()}">
                <p th:text="${usuario.bio}"></p>
            </div>
            <div class="user-bio placeholder" th:if="${usuario.bio == null or usuario.bio.isEmpty()}">
                <p class="text-muted"><i class="fas fa-quote-left"></i> No hay biograf√≠a disponible <i class="fas fa-quote-right"></i></p>
            </div>
            
            <div class="most-played">
                El juego m√°s jugado es: 
                <strong th:text="${juegoMasJugado != null ? juegoMasJugado.juego.titulo : 'Ninguno'}"></strong>
            </div>
            
            <div class="hero-buttons">
                <button class="btn-edit-profile" onclick="openEditModal()">MODIFICAR PERFIL</button>
                <button class="btn-add-friend" onclick="sendFriendRequest(this)">
                    <i class="fas fa-user-plus"></i> A√±adir amigo
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL EDITAR PERFIL -->
    <div id="editProfileModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Editar Perfil</h2>
                <span class="close-modal" onclick="closeModal('editProfileModal')">&times;</span>
            </div>
            <div class="modal-body">
                <form id="editProfileForm" onsubmit="saveProfile(event)">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                    
                    <div class="form-group">
                        <label for="nombre">Nombre</label>
                        <input type="text" id="nombre" name="nombre" th:value="${usuario.nombre}" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="bio">Biograf√≠a</label>
                        <textarea id="bio" name="bio" rows="4" class="form-control" placeholder="Cu√©ntanos sobre ti..." th:text="${usuario.bio}"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="avatarUrl">URL del Avatar</label>
                        <input type="url" id="avatarUrl" name="avatarUrl" class="form-control" placeholder="https://ejemplo.com/avatar.jpg" th:value="${usuario.avatarUrl}">
                    </div>
                    
                    <div class="form-group">
                        <label>Color del Banner</label>
                        <div class="color-options">
                            <div class="color-option" style="background: #1f2833" onclick="selectColor(this, '#1f2833')" th:classappend="${usuario.bannerColor == '#1f2833' ? 'selected' : ''}"></div>
                            <div class="color-option" style="background: #2c3e50" onclick="selectColor(this, '#2c3e50')" th:classappend="${usuario.bannerColor == '#2c3e50' ? 'selected' : ''}"></div>
                            <div class="color-option" style="background: #8e44ad" onclick="selectColor(this, '#8e44ad')" th:classappend="${usuario.bannerColor == '#8e44ad' ? 'selected' : ''}"></div>
                            <div class="color-option" style="background: #2980b9" onclick="selectColor(this, '#2980b9')" th:classappend="${usuario.bannerColor == '#2980b9' ? 'selected' : ''}"></div>
                            <div class="color-option" style="background: #27ae60" onclick="selectColor(this, '#27ae60')" th:classappend="${usuario.bannerColor == '#27ae60' ? 'selected' : ''}"></div>
                            <div class="color-option" style="background: #e74c3c" onclick="selectColor(this, '#e74c3c')" th:classappend="${usuario.bannerColor == '#e74c3c' ? 'selected' : ''}"></div>
                        </div>
                        <input type="hidden" id="bannerColor" name="bannerColor" th:value="${usuario.bannerColor}">
                    </div>
                    
                    <button type="submit" class="btn-save-profile">Guardar Cambios</button>
                </form>
            </div>
        </div>
    </div>

    <!-- LIGHTBOX PARA CAPTURAS -->
    <div id="lightbox" class="lightbox" onclick="closeLightbox(event)">
        <span class="close-lightbox" onclick="closeLightbox()">&times;</span>
        <img class="lightbox-content" id="lightbox-img">
        <div class="lightbox-caption" id="lightbox-caption"></div>
        <div class="lightbox-nav">
            <button class="lightbox-prev" onclick="navigateLightbox(-1)"><i class="fas fa-chevron-left"></i></button>
            <button class="lightbox-next" onclick="navigateLightbox(1)"><i class="fas fa-chevron-right"></i></button>
        </div>
    </div>

    <!-- CONTENIDO PRINCIPAL -->
    <div class="main-container">
        <div class="profile-grid">
            <!-- SIDEBAR IZQUIERDA -->
            <div class="sidebar">
                <!-- Tarjeta de Nivel -->
                <div class="sidebar-card">
                    <h4>Nivel <span class="level" th:text="${nivel}"></span></h4>
                    <div class="xp-bar">
                        <div class="xp-fill" th:style="'width: ' + (${xp} / 10) + '%'"></div>
                    </div>
                    <p class="xp-text" th:text="${xp} + ' / 1000 XP'"></p>
                    <p class="hours-text" th:text="${#numbers.formatDecimal(totalHoras, 1, 1)} + ' horas totales'"></p>
                </div>

                <!-- Estad√≠sticas Detalladas -->
                <div class="sidebar-card stats-card">
                    <h5>Estad√≠sticas Detalladas</h5>
                    <div class="stat-item">
                        <span>Horas Totales:</span>
                        <strong th:text="${#numbers.formatDecimal(totalHoras, 1, 1)} + ' hrs'"></strong>
                    </div>
                    <div class="stat-item">
                        <span>Juegos en Biblioteca:</span>
                        <strong th:text="${biblioteca.size()}"></strong>
                    </div>
                    <div class="stat-item">
                        <span>Logros Obtenidos:</span>
                        <strong th:text="${logrosCompletados} + '/50'"></strong>
                    </div>
                    <div class="stat-item">
                        <span>Valor Biblioteca:</span>
                        <strong>S/ <span th:text="${#numbers.formatDecimal(valorBiblioteca, 1, 2)}"></span></strong>
                    </div>
                    <div class="stat-item">
                        <span>Saldo Disponible:</span>
                        <strong>S/ <span th:text="${#numbers.formatDecimal(usuario.saldo, 1, 2)}"></span></strong>
                    </div>
                </div>
                
                <!-- SECCI√ìN DE AMIGOS ACTUALIZADA -->
                <div class="sidebar-card friends-card">
                    <h5>
                        Amigos 
                        <span class="friends-count" th:text="'(' + ${amigos != null ? amigos.size() : 0} + ')'"></span>
                    </h5>
                    
                    <!-- Si no hay amigos -->
                    <div th:if="${amigos == null or amigos.isEmpty()}" class="no-friends">
                        <p>No tienes amigos a√∫n. ¬°Conoce gente en la comunidad!</p>
                        <div class="friend-search-box">
                            <input type="email" id="friendEmail" placeholder="Email del amigo..." class="form-control">
                            <button class="btn-add-friend-small" onclick="enviarSolicitud()">
                                <i class="fas fa-user-plus"></i> Agregar
                            </button>
                        </div>
                        <a href="#" class="view-all-friends" onclick="openFriendsModal(event)">Buscar amigos ‚Üí</a>
                    </div>
                    
                    <!-- Si hay amigos -->
                    <div th:if="${amigos != null and !amigos.isEmpty()}" class="friends-list">
                        <div th:each="amigo : ${amigos}" class="friend-item">
                            <div class="friend-avatar">
                                <img th:src="${amigo.avatarUrl != null ? amigo.avatarUrl : 'https://i.pravatar.cc/150?u=' + amigo.id}" 
                                     alt="Avatar">
                                <span class="status-dot online"></span>
                            </div>
                            <div class="friend-info">
                                <span class="friend-name" th:text="${amigo.nombre}"></span>
                                <span class="friend-status">En l√≠nea</span>
                            </div>
                        </div>
                        
                        <div class="friend-actions">
                            <a href="#" class="view-all-friends" onclick="openFriendsModal(event)">
                                Ver todos (<span th:text="${amigos.size()}"></span>) ‚Üí
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- CENTRO - ACTIVIDAD RECIENTE (se mantiene igual) -->
            <div class="activity-section">
                <h3 class="section-title">Actividad Reciente</h3>
                
                <!-- Mensaje si no hay juegos -->
                <div class="no-games" th:if="${biblioteca.isEmpty()}">
                    <p>No tienes juegos en tu biblioteca. <a th:href="@{/home}">¬°Ve a la tienda a comprar algunos!</a></p>
                </div>
                
                <!-- Actividad de Juegos -->
                <div th:each="uj : ${biblioteca}" th:if="${uj != null and uj.juego != null}" class="activity-card-modern">
                    <img th:src="@{${uj.juego.coverUrl}}" class="activity-cover" 
                         onerror="this.src='https://images.unsplash.com/photo-1550745165-9bc0b252726f?w=140&h=80&fit=crop'">
                    <div class="activity-info">
                        <h4 th:text="${uj.juego.titulo}"></h4>
                        <p th:text="${uj.juego.descripcion}"></p>
                        <div class="activity-meta">
                            <span><i class="fas fa-clock"></i> <span th:text="${#numbers.formatDecimal(uj.horasJugadas,1,1)} + ' horas'"></span></span>
                            <span th:if="${uj.ultimaSesion != null}">
                                <i class="fas fa-calendar"></i> √öltima sesi√≥n: <span th:text="${#temporals.format(uj.ultimaSesion,'dd MMM')}"></span>
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Secci√≥n de Logros -->
                <div class="achievements-section">
                    <h3 class="section-title">
                        Logros Recientes
                        <span class="section-count" th:if="${logrosRecientes != null}" th:text="'(' + ${#lists.size(logrosRecientes)} + ')'"></span>
                        <span class="section-count" th:if="${logrosRecientes == null}">(0)</span>
                    </h3>
                    <div class="achievements-grid">
                        <div class="achievement-card" 
                             th:each="ul : ${logrosRecientes ?: {}}"
                             th:classappend="${ul?.completado} ? 'completed' : ''">
                            <div class="achievement-icon" th:text="${ul?.logro?.icono ?: 'üèÜ'}"></div>
                            <div class="achievement-info">
                                <h4 th:text="${ul?.logro?.nombre ?: 'Logro'}"></h4>
                                <p th:text="${ul?.logro?.descripcion ?: 'Descripci√≥n no disponible'}"></p>
                                <div class="achievement-progress">
                                    <div class="progress-bar" 
                                         th:style="'width: ' + (${ul?.progreso != null and ul?.logro?.requisitoValor != null} ? (${ul.progreso} * 100 / ${ul.logro.requisitoValor}) : 0) + '%'"></div>
                                    <span th:text="${ul?.progreso != null and ul?.logro?.requisitoValor != null} ? ${ul.progreso} + '/' + ${ul.logro.requisitoValor} : '0/0'"></span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="no-achievements" th:if="${logrosRecientes == null or #lists.isEmpty(logrosRecientes)}">
                            <p>No hay logros disponibles. ¬°Sigue jugando para desbloquearlos!</p>
                        </div>
                    </div>
                </div>

                <!-- Galer√≠a de Capturas -->
                <div class="screenshots-section">
                    <h3 class="section-title">Capturas Recientes</h3>
                    <div class="no-screenshots">
                        <p>No hay capturas disponibles. ¬°Comparte tus momentos de juego!</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
        <p>VirtualHub ¬© 2026 ‚Ä¢ Hecho con ‚ù§Ô∏è por Samuel</p>
        <div class="footer-links">
            <a href="#">Acerca de</a>
            <a href="#">T√©rminos</a>
            <a href="#">Privacidad</a>
            <a href="#">Contacto</a>
        </div>
    </footer>

    <script>
        // Variables globales
        let selectedColor = null;
        
        const screenshots = [];

        // FUNCIONES PARA MODAL DE EDICI√ìN
        function openEditModal() {
            document.getElementById('editProfileModal').style.display = 'flex';
            selectedColor = null;
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function selectColor(element, color) {
            document.querySelectorAll('.color-option').forEach(opt => opt.classList.remove('selected'));
            element.classList.add('selected');
            document.getElementById('bannerColor').value = color;
            selectedColor = color;
        }

        function saveProfile(event) {
            event.preventDefault();
            
            const token = document.querySelector('meta[name="_csrf"]').getAttribute('content');
            const header = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
            
            const formData = {
                nombre: document.getElementById('nombre').value,
                bio: document.getElementById('bio').value,
                avatarUrl: document.getElementById('avatarUrl').value,
                bannerColor: selectedColor || document.querySelector('.color-option.selected')?.style.background || '#1f2833'
            };
            
            const saveButton = event.target.querySelector('button[type="submit"]');
            const originalText = saveButton.textContent;
            saveButton.textContent = 'Guardando...';
            saveButton.disabled = true;
            
            const headers = {
                'Content-Type': 'application/json',
            };
            headers[header] = token;
            
            fetch('/perfil/actualizar', {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showNotification('Error: ' + data.error, 'error');
                } else {
                    showNotification('Perfil actualizado correctamente');
                    closeModal('editProfileModal');
                    setTimeout(() => location.reload(), 1500);
                }
            })
            .catch(error => {
                showNotification('Error al guardar los cambios', 'error');
            })
            .finally(() => {
                saveButton.textContent = originalText;
                saveButton.disabled = false;
            });
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = 'notification ' + type;
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
                <span>${message}</span>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => notification.classList.add('show'), 100);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        function sendFriendRequest(button) {
            if (!button.classList.contains('friend-request-sent')) {
                button.innerHTML = '<i class="fas fa-clock"></i> Solicitud enviada';
                button.classList.add('friend-request-sent');
                button.disabled = true;
                showNotification('Solicitud de amistad enviada');
            }
        }
        
        // ‚úÖ NUEVA FUNCI√ìN PARA ENVIAR SOLICITUD DE AMISTAD POR EMAIL
        function enviarSolicitud() {
            const email = document.getElementById('friendEmail').value;
            if (!email) {
                showNotification('Ingresa un email', 'error');
                return;
            }
            
            const token = document.querySelector('meta[name="_csrf"]').getAttribute('content');
            const header = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
            
            const headers = {
                'Content-Type': 'application/json',
            };
            headers[header] = token;
            
            fetch('/amigos/solicitud', {
                method: 'POST',
                headers: headers,
                body: JSON.stringify({ email: email })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    showNotification('Error: ' + data.error, 'error');
                } else {
                    showNotification('Solicitud enviada a ' + email);
                    document.getElementById('friendEmail').value = '';
                }
            })
            .catch(error => {
                showNotification('Error al enviar solicitud', 'error');
            });
        }

        function openFriendsModal(event) {
            event.preventDefault();
            showNotification('Funcionalidad en desarrollo', 'info');
        }

        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }
		// FUNCIONES PARA NOTIFICACIONES
		function toggleNotifications() {
		    const panel = document.getElementById('notificationsPanel');
		    panel.classList.toggle('show');
		    
		    if (panel.classList.contains('show')) {
		        cargarNotificaciones();
		    }
		}

		function cargarNotificaciones() {
		    fetch('/notificaciones/recientes')
		        .then(response => response.json())
		        .then(data => {
		            const lista = document.getElementById('notificationsList');
		            
		            if (data.length === 0) {
		                lista.innerHTML = `
		                    <div class="no-notifications">
		                        <i class="fas fa-bell-slash"></i>
		                        <p>No tienes notificaciones</p>
		                    </div>
		                `;
		                return;
		            }
		            
		            let html = '';
		            data.forEach(notif => {
		                const icono = notif.tipo === 'LOGRO' ? 'üèÜ' : 
		                             notif.tipo === 'AMIGO' ? 'üë•' : 'üîî';
		                
		                html += `
		                    <div class="notification-item ${notif.leida ? '' : 'unread'}" 
		                         onclick="marcarLeida(${notif.id})">
		                        <div class="notification-icon ${notif.tipo.toLowerCase()}">
		                            ${icono}
		                        </div>
		                        <div class="notification-content">
		                            <div class="notification-message">${notif.mensaje}</div>
		                            <div class="notification-time">${notif.fecha}</div>
		                        </div>
		                    </div>
		                `;
		            });
		            
		            lista.innerHTML = html;
		        });
		}

		function marcarLeida(id) {
		    fetch('/notificaciones/marcar/' + id, { method: 'POST' })
		        .then(() => {
		            cargarNotificaciones();
		            actualizarContador();
		        });
		}

		function marcarTodasLeidas() {
		    fetch('/notificaciones/marcar-todas', { method: 'POST' })
		        .then(() => {
		            cargarNotificaciones();
		            actualizarContador();
		        });
		}

		function actualizarContador() {
		    fetch('/notificaciones/no-leidas')
		        .then(response => response.json())
		        .then(data => {
		            const badge = document.querySelector('.notification-badge');
		            if (data.cantidad > 0) {
		                if (!badge) {
		                    const btn = document.querySelector('.btn-notifications');
		                    const newBadge = document.createElement('span');
		                    newBadge.className = 'notification-badge';
		                    newBadge.textContent = data.cantidad;
		                    btn.appendChild(newBadge);
		                } else {
		                    badge.textContent = data.cantidad;
		                }
		            } else if (badge) {
		                badge.remove();
		            }
		        });
		}

		// Cerrar panel al hacer clic fuera
		document.addEventListener('click', function(event) {
		    const panel = document.getElementById('notificationsPanel');
		    const btn = document.querySelector('.btn-notifications');
		    
		    if (!btn.contains(event.target) && !panel.contains(event.target)) {
		        panel.classList.remove('show');
		    }
		});

		// Actualizar contador cada 30 segundos
		setInterval(actualizarContador, 30000);
		
		
		document.addEventListener("DOMContentLoaded", function() {

		    const hero = document.querySelector(".steam-profile-hero");

		    hero.addEventListener("mousemove", (e) => {
		        const rect = hero.getBoundingClientRect();
		        const x = e.clientX - rect.left;
		        const y = e.clientY - rect.top;

		        hero.style.setProperty('--mouse-x', x + 'px');
		        hero.style.setProperty('--mouse-y', y + 'px');
		    });

		});
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>